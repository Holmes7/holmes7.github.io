<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><!-- <link rel="icon" type="image/svg+xml" href="/favicon.svg" /> --><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v3.1.2"><title>Ashutosh Patkar</title><script src="https://kit.fontawesome.com/dd0233f433.js" crossorigin="anonymous"></script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Comic+Neue:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap" rel="stylesheet"><link rel="stylesheet" href="/_astro/index.ae88ebf2.css" />
<style>:not(pre)>code{background-color:#2d2d2d;color:#fff;padding:.15rem .3rem;margin-right:2px;border-radius:4px;border-color:#fff;border-width:1px;font-size:.7em;line-height:1.2;box-shadow:0 1px 3px #0003}blockquote{border-left:5px solid #e28206;padding:2px 2px 2px 20px}
</style></head><!-- bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-700 via-gray-900 to-black
	bg-gradient-to-tl from-gray-700 via-gray-900 to-black
	bg-gradient-to-tl from-stone-700 via-gray-800 to-gray-900
--><body class="tracking-wide bg-gradient-to-tl from-stone-700 via-gray-800 to-gray-900 min-h-screen flex flex-col text-gray-300 font-comic max-w-screen-xl mx-auto px-7"><header class="my-7 text-xl font-bold"><nav class="flex justify-center gap-8"><a class="decoration-sky-300 decoration-2 underline-offset-8 hover:underline" href="/">Home</a><a class="decoration-sky-300 decoration-2 underline-offset-8 hover:underline" href="/tech">TechBlog</a><a class="decoration-sky-300 decoration-2 underline-offset-8 hover:underline" href="/thoughts">Thoughts</a></nav></header><div class="flex-grow pb-4 border-b-2"><article class="tracking-wide max-w-3xl mx-auto py-5 border-t-2 pt-8 prose-p:text-lg prose-h2:text-green-500 prose-h2:text-2xl prose-h2:mt-5 prose-h2:mb-2 prose-pre:p-5 prose-pre:rounded-lg prose-pre:my-3 prose-p:mb-3 prose-p:mt-3 prose-ol:mb-3 prose-a:underline prose-a:decoration-teal-400 prose-a:underline-offset-4 prose-a:decoration-1 prose-a:text-slate-200 hover:prose-a:decoration-2 prose-h3:text-orange-400 prose-h3:text-xl prose-strong:text-violet-400 prose-ol:pl-7 prose-ol:list-decimal prose-ol:list-outside prose-blockquote:mb-3 prose-blockquote:object-center prose-blockquote:italic"><h1 class="text-4xl mb-2 bg-gradient-to-r from-red-500 to-yellow-500 text-transparent bg-clip-text">Analyzing a 30x Slowdown in My Spark Program Due to Coalesce</h1><p class="text-base text-slate-400 pb-6">Published on November 15, 2023</p><p>Recently, I encountered a puzzling issue while working on a task involving pre-written Spark code. Although the code had proven itself in previous iterations, its runtime performance on my dataset was surprisingly slow. I went on to check how much data was already written and to my surprise there was a single file, no partitions, of 8.5GB size. I immediately decided to stop the program and started to investigate.</p>
<h2 id="the-culprit-coalesce1">The Culprit: coalesce(1)</h2>
<p>Upon closer inspection, the source of the sluggish performance surfaced in an unexpected place - a seemingly innocent line at the end of the code: <code>coalesce(1)</code>. To my surprise, this apparently harmless operation turned out to be the culprit behind the slowdown.</p>
<p>To quench my curiosity, I decided to experiment by removing the coalesce(1) and rerunning the code. The result was a significant boost in speed and the output also had multiple partitions.</p>
<h2 id="comparing-strategies">Comparing Strategies</h2>
<p>Intrigued by this revelation, I decided to explore further by experimenting with <code>repartition(1)</code>. To my surprise, it too ran swiftly, prompting me to delve into the differences between repartition and coalesce.</p>
<h3 id="understanding-repartition">Understanding Repartition</h3>
<p>When repartitioning, each partition is sent to an executor chosen using different algorithms. Here, I have shown <a href="https://www.quora.com/What-is-round-robin-partitioning">round robin paritioning</a>. So 1st part goes to executor 1, 2nd to executor 2, 3 to 3, and circling back, 4th to executor 1 and so on.</p>
<p><img src="https://user-images.githubusercontent.com/52966140/282919513-1e963eb3-bafc-4c3d-8d0b-b14e5df50a28.jpg" alt="Repartition"></p>
<h3 id="understanding-coalesce">Understanding Coalesce</h3>
<p>Unlike repartition, which shuffles data across the network, coalesce tries to merge partitions locally on the same executor. This strategy avoids the need for a full shuffle, which we know is quite an expensive operation since it requires redistributing partitions over the network.</p>
<p><img src="https://user-images.githubusercontent.com/52966140/282919565-3e696c74-5df0-4916-9a9d-ade0632ab4d7.jpg" alt="Coalesce"></p>
<p>So then why is coalesce running slower when it is actually avoiding a shuffle?</p>
<h2 id="the-unintended-consequence-sacrificing-parallelism">The Unintended Consequence: Sacrificing Parallelism</h2>
<p>Analyzing the Spark history server shed light on the situation. The coalesce operation, designed to sidestep shuffling, had condensed the workload onto a single executor. Surprisingly, there was only one task running in the coalesce program, in stark contrast to the repartition variant, which had spawned 36 tasks.</p>
<p>Tasks in Spark perform computations on individual partitions, executing on a single executor. Which means if we have 1 big partition, then we will have 1 task executing on single executor. If we have 1000 partitions, then 1000 tasks that can be executed in parallelI on multiple machines.</p>
<p>In the case of coalesce, the attempt to avoid shuffling accidently killed parallel processing. The entire workload was burdened onto a single executor, sacrificing the vital parallelism for efficient distributed computing.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The advice to use <code>coalesce</code> over <code>repartition</code> might work most of the times, but it doesnâ€™t work every time. Depending on the kind of workload, the tradeoffs must be considered to choose the best option.</p>
<h2 id="references">References</h2>
<p><a href="https://stackoverflow.com/questions/31610971/spark-repartition-vs-coalesce">spark-repartition-vs-coalesce</a></p></article></div><footer id="contact" class="flex flex-col pb-8 pt-5 items-center space-y-6 md:flex-row md:justify-between md:space-y-0"><div class="text-center md:text-left"><p class="text-2xl mb-2">Ashutosh Patkar</p><div class="text-sm"><p>Made Performant with Astro</p><p>and Beautiful with TailwindCSS</p></div></div><section><div class="flex flex-wrap gap-4 justify-center"><a href="https://www.linkedin.com/in/ashutosh-patkar/" class="text-2xl hover:text-sky-300"><i class="decoration-sky-300 decoration-2 underline-offset-8 hover:underline fa-brands fa-linkedin"></i></a><a href="https://github.com/Holmes7" class="text-2xl hover:text-sky-300"><i class="decoration-sky-300 decoration-2 underline-offset-8 hover:underline fa-brands fa-github"></i></a><a href="mailto:ashutoshpatkar71@gmail.com" class="text-2xl hover:text-sky-300"><i class="decoration-sky-300 decoration-2 underline-offset-8 hover:underline fa-solid fa-envelope"></i></a><a href="https://www.instagram.com/_holmes7_/" class="text-2xl hover:text-sky-300"><i class="decoration-sky-300 decoration-2 underline-offset-8 hover:underline fa-brands fa-instagram"></i></a></div></section></footer></body></html>